name: CML-Iris-Pipeline

on:
  pull_request:
    branches: [main]

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Train and evaluate model
      run: |
        mkdir -p outputs metrics
        python src/train.py
        python src/evaluate.py

    - name: Create CML report
      run: |
        echo "# ðŸŒ¸ Rapport automatique du modÃ¨le Iris" > report.md
        echo "## ðŸŽ¯ PrÃ©cision du modÃ¨le" >> report.md
        cat metrics/accuracy.txt >> report.md
        echo "## ðŸ“‰ Log Loss" >> report.md
        cat metrics/loss.txt >> report.md
        echo "## ðŸ“ˆ Matrice de confusion" >> report.md
        echo "![Confusion Matrix](outputs/confusion_matrix.png)" >> report.md
        echo "## ðŸ” Importance des features" >> report.md
        echo "![Feature Importance](outputs/feature_importance.png)" >> report.md

    - name: Post report as comment
      uses: iterative/setup-cml@v3
    - run: |
        cml comment create report.md
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
